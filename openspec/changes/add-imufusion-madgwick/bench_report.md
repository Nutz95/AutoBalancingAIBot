## Bench Report: add-imufusion-madgwick

Status: UPDATED — fusion integrated, TUNING capture performed and statistics recorded.

Summary of current findings:
- IMU fusion (Madgwick) integrated and returning `getPitch()` / `getPitchRate()`.
- TUNING CSV stream available via `TUNING START` (check `CHANNEL_TUNING`).
- Build: OK (firmware compiles and uploads).

Measured / Captured (from `tools/tuning_capture_10000/tuning_capture_10000.txt`):
- Sample rate used for fusion: ~166.7 Hz (estimated from timestamps)
- Beta used: 0.4 (firmware default; recommended tuning range 0.08–0.12)
- Stationary pitch stddev: 0.2632321 °
- Mean pitch offset at rest: 0.8818738 °
- Pitch rate stddev: 0.14683295 °/s
- Pitch rate mean: 0.03172453 °/s
-- Temperature: mean 24.79 °C, stddev 0.0645 °C

Artifacts included in this change:

- **Raw capture (CSV):** `openspec/changes/add-imufusion-madgwick/artifacts/plots/tuning_capture_10000.txt`
- **Analysis summary (text):** `openspec/changes/add-imufusion-madgwick/artifacts/summary.txt`
- **Plots (PNG):**
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/pitch_time.png`
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/pitch_hist.png`
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/pitch_psd.png`
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/allan_pitch.png`
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/allan_pr.png`
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/pitch_running_stats.png`
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/pitch_detrended.png`
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/pitch_accel_vs_fused.png`
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/pr_time.png`
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/pr_hist.png`
	- `openspec/changes/add-imufusion-madgwick/artifacts/plots/temp_vs_pitch_low.png`

If any filenames differ from the list above, tell me and I will update the report.
Calibration (from `CALIB DUMP`):
- Gyro bias (rad/s): 0.001816, 0.006141, -0.000304
- Accel offset (m/s^2): -0.195622, -0.120087, 0.000169

Notes on calibration:
- The gyro bias values above will be subtracted in the fusion pipeline; these are small and indicate a well-behaved gyro bias (~0.1 deg/s scale).
- The accelerometer offsets (in m/s^2) indicate small static offsets on X/Y; these can produce a few tenths of a degree of pitch offset depending on mounting. Use the TUNING capture to compute the mean pitch offset after applying these offsets.

Bench steps performed / notes:
1. Capture performed via serial using `TUNING START 10000`; the raw capture and analysis are stored in `tools/tuning_capture_10000/` (`tuning_capture_10000.txt` and `summary.txt`).
2. Measurements were taken with the robot stationary on its vertical support (robot powered but not balancing). These statistics therefore represent sensor/fusion noise and static bias under the board's mounted orientation.
3. The CSV capture includes the header `timestamp_ms,pitch_deg,pitch_rad,pitch_rate_deg,pitch_rate_rad,ax,ay,az,gx,gy,gz,temp_C,left_cmd,right_cmd` and 10,000 samples; an offline analysis generated the extended metrics (Allan deviaiton, RMSE vs accel, temperature correlations) saved in `summary.txt`.
4. Plots were generated by the analysis script; if you want the PNGs committed to the repo, I can add them or attach them here.

Recommendations (after capture):
- Observed pitch stddev ~0.26° (stationary) — this is reasonably low; you can safely use a lower Madgwick beta (0.08–0.12) to reduce noise in fused angle at the cost of slightly slower response.
- Mean pitch offset ~0.88° — tolerable for initial tuning but if you need zero-centered pitch for the controller, adjust accel offsets or apply an offset correction in the balancer config.
- Pitch rate noise is very low (stddev ~0.15 °/s), indicating clean gyro readings after bias subtraction; PID derivative terms should be scaled appropriately given this noise floor.

Recorder: Nutz95
Date: 2025-12-04
